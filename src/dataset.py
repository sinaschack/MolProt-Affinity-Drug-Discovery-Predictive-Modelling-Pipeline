# -*- coding: utf-8 -*-
"""dataset.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1N4dvhjlJda4THQG5TtD6tO0Qc_Ar0FXz
"""

import numpy as np
import pandas as pd
import pickle

from .featurize_molecule import smiles_to_morgan, compute_descriptors
from .featurize_protein import featurize_protein

def build_feature_matrix(csv_path, output_pickle):

    df = pd.read_csv(csv_path).drop_duplicates("smiles")

    df["morgan"] = df["smiles"].apply(smiles_to_morgan)
    df = df[df["morgan"].notnull()].reset_index(drop=True)

    df["desc"] = df["smiles"].apply(compute_descriptors)

    X_morgan = np.vstack(df["morgan"])
    X_desc = np.vstack(df["desc"])

    protein_vec = featurize_protein().reshape(1, -1)
    X_protein = np.repeat(protein_vec, repeats=len(df), axis=0)

    X = np.hstack([X_morgan, X_desc, X_protein])
    y = df["pIC50"].values

    pickle.dump({"X": X, "y": y, "smiles": df["smiles"].tolist()},
                open(output_pickle, "wb"))

    print(f"Saved: {output_pickle}")
    print("Shape:", X.shape)

    return X, y